name: Send Daily Email

on:
  schedule:
    # 08:00 UTC = 09:00 Europe/Paris (en hiver)
    - cron: "0 8 * * 1-5"
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  send:
    runs-on: ubuntu-latest
    env:
      TZ: Europe/Paris
      EMAIL_FROM: "Scanner <er.gorge@gmail.com>"
      EMAIL_TO: ${{ secrets.EMAIL_RECIPIENTS }}   # liste séparée par virgules
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r ui/requirements.txt || true
          pip install pandas yfinance requests

      - name: Show CLI help (debug)
        run: |
          python scripts/daily_run.py -h || true

      - name: Fetch market data
        run: |
          mkdir -p out
          python scripts/daily_run.py fetch \
            --watchlist data/watchlist.csv \
            --output out/quotes.parquet \
            --period 6mo

      - name: Send email (Gmail SMTP)
        run: |
          python scripts/daily_run.py email \
            --watchlist data/watchlist.csv \
            --output out/quotes.parquet \
            --period 6mo \
            --sender "${EMAIL_FROM}" \
            --recipients "${EMAIL_TO}" \
            --smtp-user "${{ secrets.SMTP_LOGIN }}" \
            --smtp-password "${{ secrets.SMTP_PASSWORD }}"
